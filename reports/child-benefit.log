Traceback (most recent call last):
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/jupyter_cache/executors/utils.py", line 51, in single_nb_execution
    executenb(
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/client.py", line 1204, in execute
    return NotebookClient(nb=nb, resources=resources, km=km, **kwargs).execute()
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/util.py", line 84, in wrapped
    return just_run(coro(*args, **kwargs))
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/util.py", line 62, in just_run
    return loop.run_until_complete(coro)
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/asyncio/base_events.py", line 647, in run_until_complete
    return future.result()
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/client.py", line 663, in async_execute
    await self.async_execute_cell(
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/client.py", line 965, in async_execute_cell
    await self._check_raise_for_error(cell, cell_index, exec_reply)
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/client.py", line 862, in _check_raise_for_error
    raise CellExecutionError.from_cell_and_msg(cell, exec_reply_content)
nbclient.exceptions.CellExecutionError: An error occurred while executing the following cell:
------------------
from policyengine_uk import IndividualSim


def get_cb_for_n_children(n):
    sim = IndividualSim(year=2022)
    for i in range(n):
        sim.add_person(age=10, name=str(i))
    sim.add_benunit(children=[str(i) for i in range(n)])
    return f'Â£{sim.calc("child_benefit").sum():.2f}'


pd.DataFrame(
    {
        "Number of children": list(range(1, 7)),
        "Child Benefit (Annual)": list(
            map(get_cb_for_n_children, range(1, 7))
        ),
    }
).set_index("Number of children")
------------------

[0;31m---------------------------------------------------------------------------[0m
[0;31mVariableNotFoundError[0m                     Traceback (most recent call last)
File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation_builder.py:536[0m, in [0;36mSimulationBuilder.init_variable_values[0;34m(self, entity, instance_object, instance_id)[0m
[1;32m    535[0m [38;5;28;01mtry[39;00m:
[0;32m--> 536[0m     [43mentity[49m[38;5;241;43m.[39;49m[43mcheck_variable_defined_for_entity[49m[43m([49m[43mvariable_name[49m[43m)[49m
[1;32m    537[0m [38;5;28;01mexcept[39;00m [38;5;167;01mValueError[39;00m [38;5;28;01mas[39;00m e:  [38;5;66;03m# The variable is defined for another entity[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/entities/entity.py:34[0m, in [0;36mEntity.check_variable_defined_for_entity[0;34m(self, variable_name)[0m
[1;32m     33[0m [38;5;28;01mdef[39;00m [38;5;21mcheck_variable_defined_for_entity[39m([38;5;28mself[39m, variable_name: [38;5;28mstr[39m) [38;5;241m-[39m[38;5;241m>[39m [38;5;28;01mNone[39;00m:
[0;32m---> 34[0m     variable_entity [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mget_variable[49m[43m([49m
[1;32m     35[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mcheck_existence[49m[38;5;241;43m=[39;49m[38;5;28;43;01mTrue[39;49;00m
[1;32m     36[0m [43m    [49m[43m)[49m[38;5;241m.[39mentity
[1;32m     37[0m     [38;5;66;03m# Should be this:[39;00m
[1;32m     38[0m     [38;5;66;03m# if variable_entity is not self:[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/entities/entity.py:29[0m, in [0;36mEntity.get_variable[0;34m(self, variable_name, check_existence)[0m
[1;32m     28[0m [38;5;28;01mdef[39;00m [38;5;21mget_variable[39m([38;5;28mself[39m, variable_name: [38;5;28mstr[39m, check_existence: [38;5;28mbool[39m [38;5;241m=[39m [38;5;28;01mFalse[39;00m):
[0;32m---> 29[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_tax_benefit_system[49m[38;5;241;43m.[39;49m[43mget_variable[49m[43m([49m
[1;32m     30[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mcheck_existence[49m
[1;32m     31[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/taxbenefitsystems/tax_benefit_system.py:440[0m, in [0;36mTaxBenefitSystem.get_variable[0;34m(self, variable_name, check_existence)[0m
[1;32m    439[0m [38;5;28;01mif[39;00m [38;5;129;01mnot[39;00m found [38;5;129;01mand[39;00m check_existence:
[0;32m--> 440[0m     [38;5;28;01mraise[39;00m VariableNotFoundError(variable_name, [38;5;28mself[39m)
[1;32m    441[0m [38;5;28;01mreturn[39;00m found

[0;31mVariableNotFoundError[0m: You tried to calculate or to set a value for variable 'children', but it was not found in the loaded tax and benefit system (policyengine-uk@0.38.2).
Are you sure you spelled 'children' correctly?
If this code used to work and suddenly does not, this is most probably linked to an update of the tax and benefit system.
Look at its changelog to learn about renames and removals and update your code. If it is an official package,
it is probably available on <https://github.com/openfisca/policyengine-uk/blob/master/CHANGELOG.md>.

During handling of the above exception, another exception occurred:

[0;31mSituationParsingError[0m                     Traceback (most recent call last)
Cell [0;32mIn[2], line 15[0m
[1;32m      8[0m     sim[38;5;241m.[39madd_benunit(children[38;5;241m=[39m[[38;5;28mstr[39m(i) [38;5;28;01mfor[39;00m i [38;5;129;01min[39;00m [38;5;28mrange[39m(n)])
[1;32m      9[0m     [38;5;28;01mreturn[39;00m [38;5;124mf[39m[38;5;124m'[39m[38;5;124mÂ£[39m[38;5;132;01m{[39;00msim[38;5;241m.[39mcalc([38;5;124m"[39m[38;5;124mchild_benefit[39m[38;5;124m"[39m)[38;5;241m.[39msum()[38;5;132;01m:[39;00m[38;5;124m.2f[39m[38;5;132;01m}[39;00m[38;5;124m'[39m
[1;32m     12[0m pd[38;5;241m.[39mDataFrame(
[1;32m     13[0m     {
[1;32m     14[0m         [38;5;124m"[39m[38;5;124mNumber of children[39m[38;5;124m"[39m: [38;5;28mlist[39m([38;5;28mrange[39m([38;5;241m1[39m, [38;5;241m7[39m)),
[0;32m---> 15[0m         [38;5;124m"[39m[38;5;124mChild Benefit (Annual)[39m[38;5;124m"[39m: [38;5;28;43mlist[39;49m[43m([49m
[1;32m     16[0m [43m            [49m[38;5;28;43mmap[39;49m[43m([49m[43mget_cb_for_n_children[49m[43m,[49m[43m [49m[38;5;28;43mrange[39;49m[43m([49m[38;5;241;43m1[39;49m[43m,[49m[43m [49m[38;5;241;43m7[39;49m[43m)[49m[43m)[49m
[1;32m     17[0m [43m        [49m[43m)[49m,
[1;32m     18[0m     }
[1;32m     19[0m )[38;5;241m.[39mset_index([38;5;124m"[39m[38;5;124mNumber of children[39m[38;5;124m"[39m)

Cell [0;32mIn[2], line 9[0m, in [0;36mget_cb_for_n_children[0;34m(n)[0m
[1;32m      7[0m     sim[38;5;241m.[39madd_person(age[38;5;241m=[39m[38;5;241m10[39m, name[38;5;241m=[39m[38;5;28mstr[39m(i))
[1;32m      8[0m sim[38;5;241m.[39madd_benunit(children[38;5;241m=[39m[[38;5;28mstr[39m(i) [38;5;28;01mfor[39;00m i [38;5;129;01min[39;00m [38;5;28mrange[39m(n)])
[0;32m----> 9[0m [38;5;28;01mreturn[39;00m [38;5;124mf[39m[38;5;124m'[39m[38;5;124mÂ£[39m[38;5;132;01m{[39;00m[43msim[49m[38;5;241;43m.[39;49m[43mcalc[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mchild_benefit[39;49m[38;5;124;43m"[39;49m[43m)[49m[38;5;241m.[39msum()[38;5;132;01m:[39;00m[38;5;124m.2f[39m[38;5;132;01m}[39;00m[38;5;124m'[39m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/individual_sim.py:239[0m, in [0;36mIndividualSim.calc[0;34m(self, var, period, target, index, map_to, reform)[0m
[1;32m    226[0m [38;5;124;03m"""Calculates the value of a variable, executing any required formulas.[39;00m
[1;32m    227[0m 
[1;32m    228[0m [38;5;124;03mArgs:[39;00m
[0;32m   (...)[0m
[1;32m    236[0m [38;5;124;03m    np.array: The resulting values.[39;00m
[1;32m    237[0m [38;5;124;03m"""[39;00m
[1;32m    238[0m [38;5;28;01mif[39;00m [38;5;129;01mnot[39;00m [38;5;28mhasattr[39m([38;5;28mself[39m, [38;5;124m"[39m[38;5;124msimulation[39m[38;5;124m"[39m):
[0;32m--> 239[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mbuild[49m[43m([49m[43m)[49m
[1;32m    241[0m [38;5;28;01mif[39;00m [38;5;28mself[39m[38;5;241m.[39mparametric_vary [38;5;129;01mand[39;00m reform [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    242[0m     results [38;5;241m=[39m [
[1;32m    243[0m         [38;5;28mself[39m[38;5;241m.[39mcalc(
[1;32m    244[0m             var,
[0;32m   (...)[0m
[1;32m    251[0m         [38;5;28;01mfor[39;00m reform [38;5;129;01min[39;00m [38;5;28mself[39m[38;5;241m.[39mparametric_reforms
[1;32m    252[0m     ]

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/individual_sim.py:87[0m, in [0;36mIndividualSim.build[0;34m(self)[0m
[1;32m     83[0m             [38;5;28mself[39m[38;5;241m.[39msituation_data[entity_metadata[38;5;241m.[39mplural][entity][
[1;32m     84[0m                 default_role[38;5;241m.[39mplural
[1;32m     85[0m             ] [38;5;241m=[39m members
[1;32m     86[0m     [38;5;66;03m# Add missing entities with specified default roles[39;00m
[0;32m---> 87[0m [38;5;28mself[39m[38;5;241m.[39msimulation [38;5;241m=[39m [43mSimulation[49m[43m([49m
[1;32m     88[0m [43m    [49m[43mtax_benefit_system[49m[38;5;241;43m=[39;49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msystem[49m[43m,[49m
[1;32m     89[0m [43m    [49m[43msituation[49m[38;5;241;43m=[39;49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msituation_data[49m[43m,[49m
[1;32m     90[0m [43m    [49m[43mreform[49m[38;5;241;43m=[39;49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mreform[49m[43m,[49m
[1;32m     91[0m [43m[49m[43m)[49m
[1;32m     92[0m [38;5;28mself[39m[38;5;241m.[39msimulation[38;5;241m.[39mtrace [38;5;241m=[39m [38;5;28;01mTrue[39;00m
[1;32m     93[0m [38;5;28mself[39m[38;5;241m.[39msim [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39msimulation

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:122[0m, in [0;36mSimulation.__init__[0;34m(self, tax_benefit_system, populations, situation, dataset, dataset_year, reform)[0m
[1;32m    120[0m     builder [38;5;241m=[39m SimulationBuilder()
[1;32m    121[0m     builder[38;5;241m.[39mdefault_period [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39mdefault_input_period
[0;32m--> 122[0m     [43mbuilder[49m[38;5;241;43m.[39;49m[43mbuild_from_dict[49m[43m([49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mtax_benefit_system[49m[43m,[49m[43m [49m[43msituation[49m[43m,[49m[43m [49m[38;5;28;43mself[39;49m[43m)[49m
[1;32m    123[0m     [38;5;28mself[39m[38;5;241m.[39mhas_axes [38;5;241m=[39m builder[38;5;241m.[39mhas_axes
[1;32m    125[0m [38;5;28;01mif[39;00m populations [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation_builder.py:82[0m, in [0;36mSimulationBuilder.build_from_dict[0;34m(self, tax_benefit_system, input_dict, simulation)[0m
[1;32m     75[0m input_dict [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39mexplicit_singular_entities(
[1;32m     76[0m     tax_benefit_system, input_dict
[1;32m     77[0m )
[1;32m     78[0m [38;5;28;01mif[39;00m [38;5;28many[39m(
[1;32m     79[0m     key [38;5;129;01min[39;00m tax_benefit_system[38;5;241m.[39mentities_plural()
[1;32m     80[0m     [38;5;28;01mfor[39;00m key [38;5;129;01min[39;00m input_dict[38;5;241m.[39mkeys()
[1;32m     81[0m ):
[0;32m---> 82[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mbuild_from_entities[49m[43m([49m
[1;32m     83[0m [43m        [49m[43mtax_benefit_system[49m[43m,[49m[43m [49m[43minput_dict[49m[43m,[49m[43m [49m[43msimulation[49m
[1;32m     84[0m [43m    [49m[43m)[49m
[1;32m     85[0m [38;5;28;01melse[39;00m:
[1;32m     86[0m     [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39mbuild_from_variables(
[1;32m     87[0m         tax_benefit_system, input_dict, simulation
[1;32m     88[0m     )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation_builder.py:163[0m, in [0;36mSimulationBuilder.build_from_entities[0;34m(self, tax_benefit_system, input_dict, simulation)[0m
[1;32m    161[0m instances_json [38;5;241m=[39m input_dict[38;5;241m.[39mget(entity_class[38;5;241m.[39mplural)
[1;32m    162[0m [38;5;28;01mif[39;00m instances_json [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:
[0;32m--> 163[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43madd_group_entity[49m[43m([49m
[1;32m    164[0m [43m        [49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mpersons_plural[49m[43m,[49m
[1;32m    165[0m [43m        [49m[43mpersons_ids[49m[43m,[49m
[1;32m    166[0m [43m        [49m[43mentity_class[49m[43m,[49m
[1;32m    167[0m [43m        [49m[43minstances_json[49m[43m,[49m
[1;32m    168[0m [43m    [49m[43m)[49m
[1;32m    169[0m [38;5;28;01melse[39;00m:
[1;32m    170[0m     [38;5;28mself[39m[38;5;241m.[39madd_default_group_entity(persons_ids, entity_class)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation_builder.py:472[0m, in [0;36mSimulationBuilder.add_group_entity[0;34m(self, persons_plural, persons_ids, entity, instances_json)[0m
[1;32m    465[0m             person_role [38;5;241m=[39m (
[1;32m    466[0m                 role[38;5;241m.[39msubroles[index_within_role]
[1;32m    467[0m                 [38;5;28;01mif[39;00m role[38;5;241m.[39msubroles
[1;32m    468[0m                 [38;5;28;01melse[39;00m role
[1;32m    469[0m             )
[1;32m    470[0m             [38;5;28mself[39m[38;5;241m.[39mroles[entity[38;5;241m.[39mplural][person_index] [38;5;241m=[39m person_role
[0;32m--> 472[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43minit_variable_values[49m[43m([49m[43mentity[49m[43m,[49m[43m [49m[43mvariables_json[49m[43m,[49m[43m [49m[43minstance_id[49m[43m)[49m
[1;32m    474[0m [38;5;28;01mif[39;00m persons_to_allocate:
[1;32m    475[0m     entity_ids [38;5;241m=[39m entity_ids [38;5;241m+[39m [38;5;28mlist[39m(persons_to_allocate)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation_builder.py:540[0m, in [0;36mSimulationBuilder.init_variable_values[0;34m(self, entity, instance_object, instance_id)[0m
[1;32m    538[0m     [38;5;28;01mraise[39;00m SituationParsingError(path_in_json, e[38;5;241m.[39margs[[38;5;241m0[39m])
[1;32m    539[0m [38;5;28;01mexcept[39;00m VariableNotFoundError [38;5;28;01mas[39;00m e:  [38;5;66;03m# The variable doesn't exist[39;00m
[0;32m--> 540[0m     [38;5;28;01mraise[39;00m SituationParsingError(path_in_json, [38;5;28mstr[39m(e), code[38;5;241m=[39m[38;5;241m404[39m)
[1;32m    542[0m instance_index [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39mget_ids(entity[38;5;241m.[39mplural)[38;5;241m.[39mindex(instance_id)
[1;32m    544[0m [38;5;28;01mif[39;00m [38;5;129;01mnot[39;00m [38;5;28misinstance[39m(variable_values, [38;5;28mdict[39m):

[0;31mSituationParsingError[0m: {'benunits': {'benunit_1': {'children': "You tried to calculate or to set a value for variable 'children', but it was not found in the loaded tax and benefit system (policyengine-uk@0.38.2). Are you sure you spelled 'children' correctly? If this code used to work and suddenly does not, this is most probably linked to an update of the tax and benefit system. Look at its changelog to learn about renames and removals and update your code. If it is an official package, it is probably available on <https://github.com/openfisca/policyengine-uk/blob/master/CHANGELOG.md>."}}}
SituationParsingError: {'benunits': {'benunit_1': {'children': "You tried to calculate or to set a value for variable 'children', but it was not found in the loaded tax and benefit system (policyengine-uk@0.38.2). Are you sure you spelled 'children' correctly? If this code used to work and suddenly does not, this is most probably linked to an update of the tax and benefit system. Look at its changelog to learn about renames and removals and update your code. If it is an official package, it is probably available on <https://github.com/openfisca/policyengine-uk/blob/master/CHANGELOG.md>."}}}

