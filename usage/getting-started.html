<!doctype html>
<html class="no-js" lang="en">
  <head><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="prev" title="Land Transaction Tax" href="../programs/gov/wra/land-transaction-tax.html" />

    <!-- Generated with Sphinx 5.0.2 and Furo 2022.12.07 -->
        <title>Getting started - PolicyEngine UK documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=91d0f0d1c444bdcb17a68e833c7a53903343c195" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">PolicyEngine UK documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">PolicyEngine UK documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Programs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../programs/gov/hmrc/child-benefit.html">Child Benefit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programs/gov/dwp/universal-credit.html">Universal Credit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programs/gov/dwp/PIP.html">Personal Independence Payment (PIP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programs/gov/dwp/pension-credit.html">Pension Credit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programs/gov/hmrc/national-insurance.html">National Insurance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programs/gov/hmrc/income-tax.html">Income Tax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programs/gov/hmrc/fuel-duty.html">Fuel Duty</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programs/gov/hmrc/stamp-duty.html">Stamp Duty Land Tax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programs/contrib/ubi-center/carbon-tax.html">Carbon taxes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programs/gov/ofgem/energy-price-guarantee.html">Energy Price Cap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programs/gov/dcms/bbc/tv-licence.html">TV Licence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programs/gov/revenue_scotland/land-and-buildings-transaction-tax.html">Land and Buildings Transaction Tax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programs/gov/wra/land-transaction-tax.html">Land Transaction Tax</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using the model</span></p>
<ul class="current">
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Getting started</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section class="tex2jax_ignore mathjax_ignore" id="getting-started">
<h1>Getting started<a class="headerlink" href="#getting-started" title="Permalink to this heading">#</a></h1>
<p>PolicyEngine has two main use-cases:</p>
<ul class="simple">
<li><p>I want to simulate policy over specific households.</p></li>
<li><p>I want to run microsimulation analyses over large datasets.</p></li>
</ul>
<p>Anyone can do the former in a few minutes of setup, but the UK’s large household surveys are only available to academics, researchers and nonprofits, so getting set up takes a bit longer (and you should <a class="reference external" href="https://policyengine.org/uk/contact">get in touch</a> so we can make it as fast as possible).</p>
<p>If you can, please use Google Colab. It’s free, and more importantly, it enables everyone to use the same computing environment, saving all the trouble of fiddling around with bad Python installations, etc. It means that the below snippet is all you need to use the full microsimulation model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!export POLICYENGINE_GITHUB_MICRODATA_AUTH_TOKEN=your_token_if_running_microsimulations
!pip install policyengine-uk
</pre></div>
</div>
<section id="household-level-analysis">
<h2>Household-level analysis<a class="headerlink" href="#household-level-analysis" title="Permalink to this heading">#</a></h2>
<p>The PolicyEngine UK Python package can be installed just like any other. Here’s an example below.</p>
<p>First, we need to install the package (please make sure you’re using Python &gt;=3.7):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>policyengine-uk
</pre></div>
</div>
<section id="simulating-current-law">
<h3>Simulating current law<a class="headerlink" href="#simulating-current-law" title="Permalink to this heading">#</a></h3>
<p>This example shows how to define a situation (you need to define the people, benefit units and households, and their variables in specific time periods) and simulate the current tax-benefit system.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The `Simulation` class is the most important class in PolicyEngine- it runs the actual simulation.</span>

<span class="kn">from</span> <span class="nn">policyengine_uk</span> <span class="kn">import</span> <span class="n">Simulation</span>

<span class="n">situation</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;people&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;person&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">2023</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span>
            <span class="s2">&quot;employment_income&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">2023</span><span class="p">:</span> <span class="mi">30_000</span><span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s2">&quot;benunits&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;benunit&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;members&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;person&quot;</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s2">&quot;households&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;household&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;members&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;person&quot;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">situation</span><span class="o">=</span><span class="n">situation</span><span class="p">)</span>

<span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="s2">&quot;income_tax&quot;</span><span class="p">,</span> <span class="mi">2023</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([3486.], dtype=float32)
</pre></div>
</div>
</div>
</div>
</section>
<section id="simulating-a-policy-reform">
<h3>Simulating a policy reform<a class="headerlink" href="#simulating-a-policy-reform" title="Permalink to this heading">#</a></h3>
<p>Now, let’s simulate a policy reform that changes a policy parameter. The <a class="reference external" href="https://openfisca.org/doc">OpenFisca documentation</a> has some excellent documentation on the syntax here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">policyengine_core.model_api</span> <span class="kn">import</span> <span class="o">*</span>


<span class="k">def</span> <span class="nf">modify_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">:</span> <span class="n">ParameterNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParameterNode</span><span class="p">:</span>
    <span class="n">parameters</span><span class="o">.</span><span class="n">gov</span><span class="o">.</span><span class="n">hmrc</span><span class="o">.</span><span class="n">income_tax</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">uk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rate</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
        <span class="n">period</span><span class="o">=</span><span class="s2">&quot;year:2023:1&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">parameters</span>


<span class="k">class</span> <span class="nc">increase_basic_rate</span><span class="p">(</span><span class="n">Reform</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modify_parameters</span><span class="p">(</span><span class="n">modify_parameters</span><span class="p">)</span>


<span class="n">baseline</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">situation</span><span class="o">=</span><span class="n">situation</span><span class="p">)</span>
<span class="n">reformed</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">situation</span><span class="o">=</span><span class="n">situation</span><span class="p">,</span> <span class="n">reform</span><span class="o">=</span><span class="n">increase_basic_rate</span><span class="p">)</span>

<span class="n">baseline_income_tax</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="s2">&quot;income_tax&quot;</span><span class="p">,</span> <span class="mi">2023</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">reformed_income_tax</span> <span class="o">=</span> <span class="n">reformed</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="s2">&quot;income_tax&quot;</span><span class="p">,</span> <span class="mi">2023</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Raising the basic rate to 25% would increase this person&#39;s income tax by £</span><span class="si">{</span><span class="n">reformed_income_tax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">baseline_income_tax</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Raising the basic rate to 25% would increase this person&#39;s income tax by £871.50
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="microsimulation-analysis">
<h2>Microsimulation analysis<a class="headerlink" href="#microsimulation-analysis" title="Permalink to this heading">#</a></h2>
<p>PolicyEngine UK has all the code needed to actually generate the microsimulation datasets from the raw dataset files if you have them, but it’s easiest to download our final datasets. To do this, you’ll need to do the following:</p>
<ul class="simple">
<li><p>Make sure you’ve got a GitHub account.</p></li>
<li><p>Have PolicyEngine grant you permissions to our data storage.</p></li>
<li><p>Download a classic Personal Access Token (GitHub settings &gt; developer settings).</p></li>
<li><p>Set it as the environment variable <code class="docutils literal notranslate"><span class="pre">POLICYENGINE_GITHUB_MICRODATA_AUTH_TOKEN</span></code></p></li>
</ul>
<p>For example, in a bash shell:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">POLICYENGINE_GITHUB_MICRODATA_AUTH_TOKEN</span><span class="o">=</span>your_token_here
</pre></div>
</div>
<section id="getting-set-up">
<h3>Getting set up<a class="headerlink" href="#getting-set-up" title="Permalink to this heading">#</a></h3>
<p>Now the datasets will be downloaded automatically as you select them. Here’s an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">policyengine_uk</span> <span class="kn">import</span> <span class="n">Microsimulation</span>

<span class="n">sim</span> <span class="o">=</span> <span class="n">Microsimulation</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;enhanced_frs&quot;</span><span class="p">)</span>

<span class="n">sim</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="s2">&quot;universal_credit&quot;</span><span class="p">,</span> <span class="mi">2023</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1e9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>68.55452074734313
</pre></div>
</div>
</div>
</div>
<p>We passed a string to indicate that we’d like to use the enhanced FRS (PolicyEngine’s most extensive dataset, with consumption, wealth and VAT imputations and full calibration to external statistics). But here are the other options we could have used:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">Microsimulation</span><span class="o">.</span><span class="n">datasets</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">Microsimulation</span><span class="o">.</span><span class="n">datasets</span><span class="p">]</span>

<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">,</span> <span class="s2">&quot;Label&quot;</span><span class="p">:</span> <span class="n">labels</span><span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Label&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
    </tr>
    <tr>
      <th>Name</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>frs_2018</th>
      <th>FRS 2018-19</th>
    </tr>
    <tr>
      <th>frs_2019</th>
      <th>FRS 2019-20</th>
    </tr>
    <tr>
      <th>frs_2020</th>
      <th>FRS 2020-21</th>
    </tr>
    <tr>
      <th>frs_2021</th>
      <th>FRS 2021-22</th>
    </tr>
    <tr>
      <th>raw_frs_2021</th>
      <th>FRS 2021-22</th>
    </tr>
    <tr>
      <th>pooled_frs_2019_21</th>
      <th>FRS 2019-21</th>
    </tr>
    <tr>
      <th>spi_enhanced_pooled_frs_2019_21</th>
      <th>SPI-enhanced FRS 2019-21</th>
    </tr>
    <tr>
      <th>calibrated_spi_enhanced_pooled_frs_2019_21</th>
      <th>Calibrated SPI-enhanced FRS 2019-21</th>
    </tr>
    <tr>
      <th>enhanced_frs</th>
      <th>Enhanced FRS</th>
    </tr>
    <tr>
      <th>ukmod_frs_2018</th>
      <th>UKMOD (2018-19 FRS)</th>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="running-reform-analyses">
<h3>Running reform analyses<a class="headerlink" href="#running-reform-analyses" title="Permalink to this heading">#</a></h3>
<p>Reforms work in exactly the same way as in the household-level analysis above. Here’s the same example reform:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">baseline</span> <span class="o">=</span> <span class="n">Microsimulation</span><span class="p">()</span>  <span class="c1"># Enhanced FRS 2022 by default</span>
<span class="n">reformed</span> <span class="o">=</span> <span class="n">Microsimulation</span><span class="p">(</span><span class="n">reform</span><span class="o">=</span><span class="n">increase_basic_rate</span><span class="p">)</span>

<span class="n">revenue</span> <span class="o">=</span> <span class="p">(</span>
    <span class="o">-</span><span class="p">(</span>
        <span class="n">reformed</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="s2">&quot;household_net_income&quot;</span><span class="p">,</span> <span class="mi">2023</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">baseline</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="s2">&quot;household_net_income&quot;</span><span class="p">,</span> <span class="mi">2023</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="o">/</span> <span class="mf">1e9</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Raising the basic rate to 25% would raise the UK £</span><span class="si">{</span><span class="n">revenue</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">bn per year&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="nn">/tmp/ipykernel_2574/731819060.py</span> in <span class="ni">&lt;cell line: 6&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="o">-</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>         <span class="n">reformed</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="s2">&quot;household_net_income&quot;</span><span class="p">,</span> <span class="mi">2023</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">7</span>         <span class="o">-</span> <span class="n">baseline</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="s2">&quot;household_net_income&quot;</span><span class="p">,</span> <span class="mi">2023</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="o">/</span> <span class="mf">1e9</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/microsimulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, use_weights, decode_enums)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span>         <span class="k">elif</span> <span class="n">period</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_calculation_period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span>             <span class="n">period</span> <span class="o">=</span> <span class="n">get_period</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_calculation_period</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">54</span>         <span class="n">values</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">map_to</span><span class="p">,</span> <span class="n">decode_enums</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">use_weights</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span>             <span class="k">return</span> <span class="n">values</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span> 
<span class="g g-Whitespace">    </span><span class="mi">387</span>         <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">388</span>             <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">390</span>                 <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode_to_str</span><span class="p">()</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">_calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">592</span>         <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">593</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">594</span>             <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">595</span> 
<span class="g g-Whitespace">    </span><span class="mi">596</span>             <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">_run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">810</span>                 <span class="k">for</span> <span class="n">added_variable</span> <span class="ow">in</span> <span class="n">adds_list</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">811</span>                     <span class="k">if</span> <span class="n">added_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_benefit_system</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">812</span>                         <span class="n">values</span> <span class="o">=</span> <span class="n">values</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">813</span>                             <span class="n">added_variable</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">map_to</span><span class="o">=</span><span class="n">variable</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">key</span>
<span class="g g-Whitespace">    </span><span class="mi">814</span>                         <span class="p">)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/microsimulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, use_weights, decode_enums)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span>         <span class="k">elif</span> <span class="n">period</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_calculation_period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span>             <span class="n">period</span> <span class="o">=</span> <span class="n">get_period</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_calculation_period</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">54</span>         <span class="n">values</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">map_to</span><span class="p">,</span> <span class="n">decode_enums</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">use_weights</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span>             <span class="k">return</span> <span class="n">values</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span> 
<span class="g g-Whitespace">    </span><span class="mi">387</span>         <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">388</span>             <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">390</span>                 <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode_to_str</span><span class="p">()</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">_calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">592</span>         <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">593</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">594</span>             <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">595</span> 
<span class="g g-Whitespace">    </span><span class="mi">596</span>             <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">_run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">875</span>             <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">876</span>         <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">877</span>             <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">878</span> 
<span class="g g-Whitespace">    </span><span class="mi">879</span>         <span class="k">return</span> <span class="n">array</span>

<span class="nn">~/work/policyengine-uk/policyengine-uk/policyengine_uk/variables/household/income/benefit.py</span> in <span class="ni">formula</span><span class="nt">(household, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">99</span>                 <span class="k">if</span> <span class="n">benefit</span> <span class="o">!=</span> <span class="s2">&quot;council_tax_benefit&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">100</span>             <span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">101</span>         <span class="n">general_benefits</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">102</span>             <span class="n">household</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">103</span>             <span class="n">period</span><span class="p">,</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py</span> in <span class="ni">add</span><span class="nt">(entity, period, variables, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">225</span>         <span class="n">ArrayLike</span><span class="p">:</span> <span class="n">The</span> <span class="n">result</span> <span class="n">of</span> <span class="n">the</span> <span class="n">operation</span><span class="o">.</span>
<span class="g g-Whitespace">    </span><span class="mi">226</span>     <span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">227</span><span class="s2">     return for_each_variable(</span>
<span class="g g-Whitespace">    </span><span class="mi">228</span><span class="s2">         entity, period, variables, agg_func=&quot;add&quot;, options=options</span>
<span class="g g-Whitespace">    </span><span class="mi">229</span><span class="s2">     )</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py</span> in <span class="ni">for_each_variable</span><span class="nt">(entity, period, variables, agg_func, group_agg_func, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">195</span><span class="s2">             ]</span>
<span class="g g-Whitespace">    </span><span class="mi">196</span><span class="s2">             person_shares = variable_population.project(</span>
<span class="ne">--&gt; </span><span class="mi">197</span><span class="s2">                 variable_population(variable, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">198</span><span class="s2">             ) / variable_population.project(variable_population.nb_persons())</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span><span class="s2">             values = entity.sum(person_shares)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py</span> in <span class="ni">__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span><span class="s2">             )</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span><span class="s2">         else:</span>
<span class="ne">--&gt; </span><span class="mi">134</span><span class="s2">             return self.simulation.calculate(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span><span class="s2">                 variable_name, period, **calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span><span class="s2">             )</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/microsimulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, use_weights, decode_enums)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span><span class="s2">         elif period is None and self.default_calculation_period is not None:</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span><span class="s2">             period = get_period(self.default_calculation_period)</span>
<span class="ne">---&gt; </span><span class="mi">54</span><span class="s2">         values = super().calculate(variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span><span class="s2">         if not use_weights:</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span><span class="s2">             return values</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">387</span><span class="s2">         try:</span>
<span class="ne">--&gt; </span><span class="mi">388</span><span class="s2">             result = self._calculate(variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span><span class="s2">             if isinstance(result, EnumArray) and decode_enums:</span>
<span class="g g-Whitespace">    </span><span class="mi">390</span><span class="s2">                 result = result.decode_to_str()</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">_calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">576</span><span class="s2">         if variable.defined_for is not None:</span>
<span class="g g-Whitespace">    </span><span class="mi">577</span><span class="s2">             mask = (</span>
<span class="ne">--&gt; </span><span class="mi">578</span><span class="s2">                 self.calculate(</span>
<span class="g g-Whitespace">    </span><span class="mi">579</span><span class="s2">                     variable.defined_for, period, map_to=variable.entity.key</span>
<span class="g g-Whitespace">    </span><span class="mi">580</span><span class="s2">                 )</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/microsimulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, use_weights, decode_enums)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span><span class="s2">         elif period is None and self.default_calculation_period is not None:</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span><span class="s2">             period = get_period(self.default_calculation_period)</span>
<span class="ne">---&gt; </span><span class="mi">54</span><span class="s2">         values = super().calculate(variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span><span class="s2">         if not use_weights:</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span><span class="s2">             return values</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">387</span><span class="s2">         try:</span>
<span class="ne">--&gt; </span><span class="mi">388</span><span class="s2">             result = self._calculate(variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span><span class="s2">             if isinstance(result, EnumArray) and decode_enums:</span>
<span class="g g-Whitespace">    </span><span class="mi">390</span><span class="s2">                 result = result.decode_to_str()</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">_calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">592</span><span class="s2">         try:</span>
<span class="g g-Whitespace">    </span><span class="mi">593</span><span class="s2">             self._check_for_cycle(variable.name, period)</span>
<span class="ne">--&gt; </span><span class="mi">594</span><span class="s2">             array = self._run_formula(variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">595</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">596</span><span class="s2">             # If no result, use the default value and cache it</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">_run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">875</span><span class="s2">             array = formula(population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">876</span><span class="s2">         else:</span>
<span class="ne">--&gt; </span><span class="mi">877</span><span class="s2">             array = formula(population, period, parameters_at)</span>
<span class="g g-Whitespace">    </span><span class="mi">878</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">879</span><span class="s2">         return array</span>

<span class="nn">~/work/policyengine-uk/policyengine-uk/policyengine_uk/variables/gov/dwp/housing_benefit.py</span> in <span class="ni">formula</span><span class="nt">(benunit, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">39</span><span class="s2">         reported_hb = add(benunit, period, [&quot;housing_benefit_reported&quot;]) &gt; 0</span>
<span class="g g-Whitespace">     </span><span class="mi">40</span><span class="s2">         baseline = benunit(&quot;baseline_housing_benefit_entitlement&quot;, period) &gt; 0</span>
<span class="ne">---&gt; </span><span class="mi">41</span><span class="s2">         eligible = benunit(&quot;housing_benefit_entitlement&quot;, period) &gt; 0</span>
<span class="g g-Whitespace">     </span><span class="mi">42</span><span class="s2">         takeup_rate = parameters(period).gov.dwp.housing_benefit.takeup</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span><span class="s2">         return select(</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py</span> in <span class="ni">__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span><span class="s2">             )</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span><span class="s2">         else:</span>
<span class="ne">--&gt; </span><span class="mi">134</span><span class="s2">             return self.simulation.calculate(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span><span class="s2">                 variable_name, period, **calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span><span class="s2">             )</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/microsimulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, use_weights, decode_enums)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span><span class="s2">         elif period is None and self.default_calculation_period is not None:</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span><span class="s2">             period = get_period(self.default_calculation_period)</span>
<span class="ne">---&gt; </span><span class="mi">54</span><span class="s2">         values = super().calculate(variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span><span class="s2">         if not use_weights:</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span><span class="s2">             return values</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">387</span><span class="s2">         try:</span>
<span class="ne">--&gt; </span><span class="mi">388</span><span class="s2">             result = self._calculate(variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span><span class="s2">             if isinstance(result, EnumArray) and decode_enums:</span>
<span class="g g-Whitespace">    </span><span class="mi">390</span><span class="s2">                 result = result.decode_to_str()</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">_calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">592</span><span class="s2">         try:</span>
<span class="g g-Whitespace">    </span><span class="mi">593</span><span class="s2">             self._check_for_cycle(variable.name, period)</span>
<span class="ne">--&gt; </span><span class="mi">594</span><span class="s2">             array = self._run_formula(variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">595</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">596</span><span class="s2">             # If no result, use the default value and cache it</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">_run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">875</span><span class="s2">             array = formula(population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">876</span><span class="s2">         else:</span>
<span class="ne">--&gt; </span><span class="mi">877</span><span class="s2">             array = formula(population, period, parameters_at)</span>
<span class="g g-Whitespace">    </span><span class="mi">878</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">879</span><span class="s2">         return array</span>

<span class="nn">~/work/policyengine-uk/policyengine-uk/policyengine_uk/variables/gov/dwp/housing_benefit.py</span> in <span class="ni">formula</span><span class="nt">(benunit, period, parameters)</span>
<span class="g g-Whitespace">    </span><span class="mi">226</span><span class="s2">         )</span>
<span class="g g-Whitespace">    </span><span class="mi">227</span><span class="s2">         amount = where(</span>
<span class="ne">--&gt; </span><span class="mi">228</span><span class="s2">             LHA, min_(final_amount, benunit(&quot;LHA_cap&quot;, period)), final_amount</span>
<span class="g g-Whitespace">    </span><span class="mi">229</span><span class="s2">         )</span>
<span class="g g-Whitespace">    </span><span class="mi">230</span><span class="s2">         return max_(0, amount - benunit(&quot;HB_non_dep_deductions&quot;, period))</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py</span> in <span class="ni">__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span><span class="s2">             )</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span><span class="s2">         else:</span>
<span class="ne">--&gt; </span><span class="mi">134</span><span class="s2">             return self.simulation.calculate(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span><span class="s2">                 variable_name, period, **calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span><span class="s2">             )</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/microsimulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, use_weights, decode_enums)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span><span class="s2">         elif period is None and self.default_calculation_period is not None:</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span><span class="s2">             period = get_period(self.default_calculation_period)</span>
<span class="ne">---&gt; </span><span class="mi">54</span><span class="s2">         values = super().calculate(variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span><span class="s2">         if not use_weights:</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span><span class="s2">             return values</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">387</span><span class="s2">         try:</span>
<span class="ne">--&gt; </span><span class="mi">388</span><span class="s2">             result = self._calculate(variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span><span class="s2">             if isinstance(result, EnumArray) and decode_enums:</span>
<span class="g g-Whitespace">    </span><span class="mi">390</span><span class="s2">                 result = result.decode_to_str()</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">_calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">592</span><span class="s2">         try:</span>
<span class="g g-Whitespace">    </span><span class="mi">593</span><span class="s2">             self._check_for_cycle(variable.name, period)</span>
<span class="ne">--&gt; </span><span class="mi">594</span><span class="s2">             array = self._run_formula(variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">595</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">596</span><span class="s2">             # If no result, use the default value and cache it</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">_run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">875</span><span class="s2">             array = formula(population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">876</span><span class="s2">         else:</span>
<span class="ne">--&gt; </span><span class="mi">877</span><span class="s2">             array = formula(population, period, parameters_at)</span>
<span class="g g-Whitespace">    </span><span class="mi">878</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">879</span><span class="s2">         return array</span>

<span class="nn">~/work/policyengine-uk/policyengine-uk/policyengine_uk/variables/gov/dwp/LHA.py</span> in <span class="ni">formula</span><span class="nt">(benunit, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">85</span><span class="s2">     def formula(benunit, period, parameters):</span>
<span class="g g-Whitespace">     </span><span class="mi">86</span><span class="s2">         rent = benunit(&quot;benunit_rent&quot;, period)</span>
<span class="ne">---&gt; </span><span class="mi">87</span><span class="s2">         cap = benunit(&quot;BRMA_LHA_rate&quot;, period)</span>
<span class="g g-Whitespace">     </span><span class="mi">88</span><span class="s2">         return min_(rent, cap)</span>
<span class="g g-Whitespace">     </span><span class="mi">89</span><span class="s2"> </span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py</span> in <span class="ni">__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span><span class="s2">             )</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span><span class="s2">         else:</span>
<span class="ne">--&gt; </span><span class="mi">134</span><span class="s2">             return self.simulation.calculate(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span><span class="s2">                 variable_name, period, **calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span><span class="s2">             )</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/microsimulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, use_weights, decode_enums)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span><span class="s2">         elif period is None and self.default_calculation_period is not None:</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span><span class="s2">             period = get_period(self.default_calculation_period)</span>
<span class="ne">---&gt; </span><span class="mi">54</span><span class="s2">         values = super().calculate(variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span><span class="s2">         if not use_weights:</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span><span class="s2">             return values</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">387</span><span class="s2">         try:</span>
<span class="ne">--&gt; </span><span class="mi">388</span><span class="s2">             result = self._calculate(variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span><span class="s2">             if isinstance(result, EnumArray) and decode_enums:</span>
<span class="g g-Whitespace">    </span><span class="mi">390</span><span class="s2">                 result = result.decode_to_str()</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">_calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">592</span><span class="s2">         try:</span>
<span class="g g-Whitespace">    </span><span class="mi">593</span><span class="s2">             self._check_for_cycle(variable.name, period)</span>
<span class="ne">--&gt; </span><span class="mi">594</span><span class="s2">             array = self._run_formula(variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">595</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">596</span><span class="s2">             # If no result, use the default value and cache it</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py</span> in <span class="ni">_run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">875</span><span class="s2">             array = formula(population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">876</span><span class="s2">         else:</span>
<span class="ne">--&gt; </span><span class="mi">877</span><span class="s2">             array = formula(population, period, parameters_at)</span>
<span class="g g-Whitespace">    </span><span class="mi">878</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">879</span><span class="s2">         return array</span>

<span class="nn">~/work/policyengine-uk/policyengine-uk/policyengine_uk/variables/gov/dwp/LHA.py</span> in <span class="ni">formula</span><span class="nt">(benunit, period, parameters)</span>
<span class="g g-Whitespace">    </span><span class="mi">243</span><span class="s2">             }</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">         )</span>
<span class="ne">--&gt; </span><span class="mi">245</span><span class="s2">         lha_lookup_table[&quot;weekly_rent&quot;] = lha_lookup_table.apply(</span>
<span class="g g-Whitespace">    </span><span class="mi">246</span><span class="s2">             lambda x: lha_rates.loc[x.brma, x.lha_category], axis=1</span>
<span class="g g-Whitespace">    </span><span class="mi">247</span><span class="s2">         )</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/pandas/core/frame.py</span> in <span class="ni">apply</span><span class="nt">(self, func, axis, raw, result_type, args, by_row, engine, engine_kwargs, **kwargs)</span>
<span class="g g-Whitespace">  </span><span class="mi">10372</span><span class="s2">             kwargs=kwargs,</span>
<span class="g g-Whitespace">  </span><span class="mi">10373</span><span class="s2">         )</span>
<span class="ne">&gt; </span><span class="mi">10374</span><span class="s2">         return op.apply().__finalize__(self, method=&quot;apply&quot;)</span>
<span class="g g-Whitespace">  </span><span class="mi">10375</span><span class="s2"> </span>
<span class="g g-Whitespace">  </span><span class="mi">10376</span><span class="s2">     def map(</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/pandas/core/apply.py</span> in <span class="ni">apply</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">914</span><span class="s2">             return self.apply_raw(engine=self.engine, engine_kwargs=self.engine_kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">915</span><span class="s2"> </span>
<span class="ne">--&gt; </span><span class="mi">916</span><span class="s2">         return self.apply_standard()</span>
<span class="g g-Whitespace">    </span><span class="mi">917</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">918</span><span class="s2">     def agg(self):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/pandas/core/apply.py</span> in <span class="ni">apply_standard</span><span class="nt">(self)</span>
<span class="g g-Whitespace">   </span><span class="mi">1061</span><span class="s2">     def apply_standard(self):</span>
<span class="g g-Whitespace">   </span><span class="mi">1062</span><span class="s2">         if self.engine == &quot;python&quot;:</span>
<span class="ne">-&gt; </span><span class="mi">1063</span><span class="s2">             results, res_index = self.apply_series_generator()</span>
<span class="g g-Whitespace">   </span><span class="mi">1064</span><span class="s2">         else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1065</span><span class="s2">             results, res_index = self.apply_series_numba()</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/pandas/core/apply.py</span> in <span class="ni">apply_series_generator</span><span class="nt">(self)</span>
<span class="g g-Whitespace">   </span><span class="mi">1079</span><span class="s2">             for i, v in enumerate(series_gen):</span>
<span class="g g-Whitespace">   </span><span class="mi">1080</span><span class="s2">                 # ignore SettingWithCopy here in case the user mutates</span>
<span class="ne">-&gt; </span><span class="mi">1081</span><span class="s2">                 results[i] = self.func(v, *self.args, **self.kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1082</span><span class="s2">                 if isinstance(results[i], ABCSeries):</span>
<span class="g g-Whitespace">   </span><span class="mi">1083</span><span class="s2">                     # If we have a view on v, we need to make a copy because</span>

<span class="nn">~/work/policyengine-uk/policyengine-uk/policyengine_uk/variables/gov/dwp/LHA.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(x)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">         )</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">         lha_lookup_table[&quot;weekly_rent&quot;] = lha_lookup_table.apply(</span>
<span class="ne">--&gt; </span><span class="mi">246</span><span class="s2">             lambda x: lha_rates.loc[x.brma, x.lha_category], axis=1</span>
<span class="g g-Whitespace">    </span><span class="mi">247</span><span class="s2">         )</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="s2">         return lha_lookup_table.weekly_rent.values * 52</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/pandas/core/indexing.py</span> in <span class="ni">__getitem__</span><span class="nt">(self, key)</span>
<span class="g g-Whitespace">   </span><span class="mi">1182</span><span class="s2">             if self._is_scalar_access(key):</span>
<span class="g g-Whitespace">   </span><span class="mi">1183</span><span class="s2">                 return self.obj._get_value(*key, takeable=self._takeable)</span>
<span class="ne">-&gt; </span><span class="mi">1184</span><span class="s2">             return self._getitem_tuple(key)</span>
<span class="g g-Whitespace">   </span><span class="mi">1185</span><span class="s2">         else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1186</span><span class="s2">             # we by definition only have the 0th axis</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/pandas/core/indexing.py</span> in <span class="ni">_getitem_tuple</span><span class="nt">(self, tup)</span>
<span class="g g-Whitespace">   </span><span class="mi">1366</span><span class="s2">         with suppress(IndexingError):</span>
<span class="g g-Whitespace">   </span><span class="mi">1367</span><span class="s2">             tup = self._expand_ellipsis(tup)</span>
<span class="ne">-&gt; </span><span class="mi">1368</span><span class="s2">             return self._getitem_lowerdim(tup)</span>
<span class="g g-Whitespace">   </span><span class="mi">1369</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1370</span><span class="s2">         # no multi-index, so validate all of the indexers</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/pandas/core/indexing.py</span> in <span class="ni">_getitem_lowerdim</span><span class="nt">(self, tup)</span>
<span class="g g-Whitespace">   </span><span class="mi">1055</span><span class="s2">             #  (see the other place where we call _handle_lowerdim_multi_index_axis0)</span>
<span class="g g-Whitespace">   </span><span class="mi">1056</span><span class="s2">             with suppress(IndexingError):</span>
<span class="ne">-&gt; </span><span class="mi">1057</span><span class="s2">                 return cast(_LocIndexer, self)._handle_lowerdim_multi_index_axis0(tup)</span>
<span class="g g-Whitespace">   </span><span class="mi">1058</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1059</span><span class="s2">         tup = self._validate_key_length(tup)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/pandas/core/indexing.py</span> in <span class="ni">_handle_lowerdim_multi_index_axis0</span><span class="nt">(self, tup)</span>
<span class="g g-Whitespace">   </span><span class="mi">1386</span><span class="s2">         try:</span>
<span class="g g-Whitespace">   </span><span class="mi">1387</span><span class="s2">             # fast path for series or for tup devoid of slices</span>
<span class="ne">-&gt; </span><span class="mi">1388</span><span class="s2">             return self._get_label(tup, axis=axis)</span>
<span class="g g-Whitespace">   </span><span class="mi">1389</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1390</span><span class="s2">         except KeyError as ek:</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/pandas/core/indexing.py</span> in <span class="ni">_get_label</span><span class="nt">(self, label, axis)</span>
<span class="g g-Whitespace">   </span><span class="mi">1379</span><span class="s2">     def _get_label(self, label, axis: AxisInt):</span>
<span class="g g-Whitespace">   </span><span class="mi">1380</span><span class="s2">         # GH#5567 this will fail if the label is not present in the axis.</span>
<span class="ne">-&gt; </span><span class="mi">1381</span><span class="s2">         return self.obj.xs(label, axis=axis)</span>
<span class="g g-Whitespace">   </span><span class="mi">1382</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1383</span><span class="s2">     def _handle_lowerdim_multi_index_axis0(self, tup: tuple):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/pandas/core/generic.py</span> in <span class="ni">xs</span><span class="nt">(self, key, axis, level, drop_level)</span>
<span class="g g-Whitespace">   </span><span class="mi">4291</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">4292</span><span class="s2">         if isinstance(index, MultiIndex):</span>
<span class="ne">-&gt; </span><span class="mi">4293</span><span class="s2">             loc, new_index = index._get_loc_level(key, level=0)</span>
<span class="g g-Whitespace">   </span><span class="mi">4294</span><span class="s2">             if not drop_level:</span>
<span class="g g-Whitespace">   </span><span class="mi">4295</span><span class="s2">                 if lib.is_integer(loc):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/pandas/core/indexes/multi.py</span> in <span class="ni">_get_loc_level</span><span class="nt">(self, key, level)</span>
<span class="g g-Whitespace">   </span><span class="mi">3218</span><span class="s2">                     # Complete key in unique index -&gt; standard get_loc</span>
<span class="g g-Whitespace">   </span><span class="mi">3219</span><span class="s2">                     try:</span>
<span class="ne">-&gt; </span><span class="mi">3220</span><span class="s2">                         return (self._engine.get_loc(key), None)</span>
<span class="g g-Whitespace">   </span><span class="mi">3221</span><span class="s2">                     except KeyError as err:</span>
<span class="g g-Whitespace">   </span><span class="mi">3222</span><span class="s2">                         raise KeyError(key) from err</span>

<span class="nn">index.pyx</span> in <span class="ni">pandas._libs.index.BaseMultiIndexCodesEngine.get_loc</span><span class="nt">()</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p>The <a class="reference external" href="https://policyengine.org">PolicyEngine web app</a> actually has a helpful tool for this: if you can generate a household or reform on the app, scroll down in the bottom left to the <code class="docutils literal notranslate"><span class="pre">Reproduce</span> <span class="pre">in</span> <span class="pre">Python</span></code> section, and you’ll see an automatically-generated code snippet to reproduce the same analysis in Python.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./usage"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          <a class="prev-page" href="../programs/gov/wra/land-transaction-tax.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Land Transaction Tax</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Getting started</a><ul>
<li><a class="reference internal" href="#household-level-analysis">Household-level analysis</a><ul>
<li><a class="reference internal" href="#simulating-current-law">Simulating current law</a></li>
<li><a class="reference internal" href="#simulating-a-policy-reform">Simulating a policy reform</a></li>
</ul>
</li>
<li><a class="reference internal" href="#microsimulation-analysis">Microsimulation analysis</a><ul>
<li><a class="reference internal" href="#getting-set-up">Getting set up</a></li>
<li><a class="reference internal" href="#running-reform-analyses">Running reform analyses</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    </body>
</html>